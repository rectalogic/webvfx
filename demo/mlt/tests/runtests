#!/usr/bin/env bash

FIXTURE_DIR=${1:?Usage: $(basename $0) FIXTURE_DIR OUTPUT_DIR}
OUTPUT_DIR=${2:?Usage: $(basename $0) FIXTURE_DIR OUTPUT_DIR}

BASEDIR=$(dirname "${BASH_SOURCE[0]}")

FAILED=()
for PLUGIN in frei0r mlt; do
    mkdir -p "$OUTPUT_DIR/$PLUGIN/compare"

    env SHELLOPTS=xtrace PLUGIN=$PLUGIN "${BASEDIR}/extract_frames" "$OUTPUT_DIR/$PLUGIN"

    for fixture in "${FIXTURE_DIR}/${PLUGIN}/"*.png; do
        name=$(basename "$fixture")
        # ImageMagick compare
        if ! compare -metric MAE "$fixture" "${OUTPUT_DIR}/${PLUGIN}/${name}" "${OUTPUT_DIR}/${PLUGIN}/compare/${name}"; then
            FAILED+=("${PLUGIN}/${name}")
        fi
    done
done

if [ ${#FAILED[*]} != 0 ]; then
    echo Failed: ${FAILED[@]}
    exit 1
fi
